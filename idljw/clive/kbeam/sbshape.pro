pro initbeam,beam=bm,cutdown=cutdown ; initializes the parameters of the neutral beam for quick calculation storing direction vectors in a common block
default,bm,'ss'
holp=transpose($
[[   -0.0825000,   0.0135000],$
[   -0.0660000,   0.0135000],$
[   -0.0495000,   0.0135000],$
[   -0.0330000,   0.0135000],$
[   -0.0165000,   0.0135000],$
[      0.00000,   0.0135000],$
[    0.0165000,   0.0135000],$
[    0.0330000,   0.0135000],$
[    0.0495000,   0.0135000],$
[    0.0660000,   0.0135000],$
[    0.0825000,   0.0135000],$
[   -0.0825000,   0.0475000],$
[   -0.0660000,   0.0475000],$
[   -0.0495000,   0.0475000],$
[   -0.0330000,   0.0475000],$
[   -0.0165000,   0.0475000],$
[      0.00000,   0.0475000],$
[    0.0165000,   0.0475000],$
[    0.0330000,   0.0475000],$
[    0.0495000,   0.0475000],$
[    0.0660000,   0.0475000],$
[    0.0825000,   0.0475000],$
[   -0.0825000,   0.0815000],$
[   -0.0660000,   0.0815000],$
[   -0.0495000,   0.0815000],$
[   -0.0330000,   0.0815000],$
[   -0.0165000,   0.0815000],$
[      0.00000,   0.0815000],$
[    0.0165000,   0.0815000],$
[    0.0330000,   0.0815000],$
[    0.0495000,   0.0815000],$
[    0.0660000,   0.0815000],$
[    0.0825000,   0.0815000],$
[   -0.0825000,    0.115500],$
[   -0.0660000,    0.115500],$
[   -0.0495000,    0.115500],$
[   -0.0330000,    0.115500],$
[   -0.0165000,    0.115500],$
[      0.00000,    0.115500],$
[    0.0165000,    0.115500],$
[    0.0330000,    0.115500],$
[    0.0495000,    0.115500],$
[    0.0660000,    0.115500],$
[    0.0825000,    0.115500],$
[   -0.0825000,    0.149500],$
[   -0.0660000,    0.149500],$
[   -0.0495000,    0.149500],$
[   -0.0330000,    0.149500],$
[   -0.0165000,    0.149500],$
[      0.00000,    0.149500],$
[    0.0165000,    0.149500],$
[    0.0330000,    0.149500],$
[    0.0495000,    0.149500],$
[    0.0660000,    0.149500],$
[    0.0825000,    0.149500],$
[   -0.0825000,    0.183500],$
[   -0.0660000,    0.183500],$
[   -0.0495000,    0.183500],$
[   -0.0330000,    0.183500],$
[   -0.0165000,    0.183500],$
[      0.00000,    0.183500],$
[    0.0165000,    0.183500],$
[    0.0330000,    0.183500],$
[    0.0495000,    0.183500],$
[    0.0660000,    0.183500],$
[    0.0825000,    0.183500],$
[   -0.0330000,    0.217500],$
[   -0.0165000,    0.217500],$
[      0.00000,    0.217500],$
[    0.0165000,    0.217500],$
[    0.0330000,    0.217500],$
[   -0.0742500,   0.0305000],$
[   -0.0577500,   0.0305000],$
[   -0.0412500,   0.0305000],$
[   -0.0247500,   0.0305000],$
[  -0.00825000,   0.0305000],$
[   0.00825000,   0.0305000],$
[    0.0247500,   0.0305000],$
[    0.0412500,   0.0305000],$
[    0.0577500,   0.0305000],$
[    0.0742500,   0.0305000],$
[   -0.0742500,   0.0645000],$
[   -0.0577500,   0.0645000],$
[   -0.0412500,   0.0645000],$
[   -0.0247500,   0.0645000],$
[  -0.00825000,   0.0645000],$
[   0.00825000,   0.0645000],$
[    0.0247500,   0.0645000],$
[    0.0412500,   0.0645000],$
[    0.0577500,   0.0645000],$
[    0.0742500,   0.0645000],$
[   -0.0742500,   0.0985000],$
[   -0.0577500,   0.0985000],$
[   -0.0412500,   0.0985000],$
[   -0.0247500,   0.0985000],$
[  -0.00825000,   0.0985000],$
[   0.00825000,   0.0985000],$
[    0.0247500,   0.0985000],$
[    0.0412500,   0.0985000],$
[    0.0577500,   0.0985000],$
[    0.0742500,   0.0985000],$
[   -0.0742500,    0.132500],$
[   -0.0577500,    0.132500],$
[   -0.0412500,    0.132500],$
[   -0.0247500,    0.132500],$
[  -0.00825000,    0.132500],$
[   0.00825000,    0.132500],$
[    0.0247500,    0.132500],$
[    0.0412500,    0.132500],$
[    0.0577500,    0.132500],$
[    0.0742500,    0.132500],$
[   -0.0742500,    0.166500],$
[   -0.0577500,    0.166500],$
[   -0.0412500,    0.166500],$
[   -0.0247500,    0.166500],$
[  -0.00825000,    0.166500],$
[   0.00825000,    0.166500],$
[    0.0247500,    0.166500],$
[    0.0412500,    0.166500],$
[    0.0577500,    0.166500],$
[    0.0742500,    0.166500],$
[   -0.0742500,    0.200500],$
[   -0.0577500,    0.200500],$
[   -0.0412500,    0.200500],$
[   -0.0247500,    0.200500],$
[  -0.00825000,    0.200500],$
[   0.00825000,    0.200500],$
[    0.0247500,    0.200500],$
[    0.0412500,    0.200500],$
[    0.0577500,    0.200500],$
[    0.0742500,    0.200500],$
[   -0.0825000,  -0.0135000],$
[   -0.0660000,  -0.0135000],$
[   -0.0495000,  -0.0135000],$
[   -0.0330000,  -0.0135000],$
[   -0.0165000,  -0.0135000],$
[      0.00000,  -0.0135000],$
[    0.0165000,  -0.0135000],$
[    0.0330000,  -0.0135000],$
[    0.0495000,  -0.0135000],$
[    0.0660000,  -0.0135000],$
[    0.0825000,  -0.0135000],$
[   -0.0825000,  -0.0475000],$
[   -0.0660000,  -0.0475000],$
[   -0.0495000,  -0.0475000],$
[   -0.0330000,  -0.0475000],$
[   -0.0165000,  -0.0475000],$
[      0.00000,  -0.0475000],$
[    0.0165000,  -0.0475000],$
[    0.0330000,  -0.0475000],$
[    0.0495000,  -0.0475000],$
[    0.0660000,  -0.0475000],$
[    0.0825000,  -0.0475000],$
[   -0.0825000,  -0.0815000],$
[   -0.0660000,  -0.0815000],$
[   -0.0495000,  -0.0815000],$
[   -0.0330000,  -0.0815000],$
[   -0.0165000,  -0.0815000],$
[      0.00000,  -0.0815000],$
[    0.0165000,  -0.0815000],$
[    0.0330000,  -0.0815000],$
[    0.0495000,  -0.0815000],$
[    0.0660000,  -0.0815000],$
[    0.0825000,  -0.0815000],$
[   -0.0825000,   -0.115500],$
[   -0.0660000,   -0.115500],$
[   -0.0495000,   -0.115500],$
[   -0.0330000,   -0.115500],$
[   -0.0165000,   -0.115500],$
[      0.00000,   -0.115500],$
[    0.0165000,   -0.115500],$
[    0.0330000,   -0.115500],$
[    0.0495000,   -0.115500],$
[    0.0660000,   -0.115500],$
[    0.0825000,   -0.115500],$
[   -0.0825000,   -0.149500],$
[   -0.0660000,   -0.149500],$
[   -0.0495000,   -0.149500],$
[   -0.0330000,   -0.149500],$
[   -0.0165000,   -0.149500],$
[      0.00000,   -0.149500],$
[    0.0165000,   -0.149500],$
[    0.0330000,   -0.149500],$
[    0.0495000,   -0.149500],$
[    0.0660000,   -0.149500],$
[    0.0825000,   -0.149500],$
[   -0.0825000,   -0.183500],$
[   -0.0660000,   -0.183500],$
[   -0.0495000,   -0.183500],$
[   -0.0330000,   -0.183500],$
[   -0.0165000,   -0.183500],$
[      0.00000,   -0.183500],$
[    0.0165000,   -0.183500],$
[    0.0330000,   -0.183500],$
[    0.0495000,   -0.183500],$
[    0.0660000,   -0.183500],$
[    0.0825000,   -0.183500],$
[   -0.0330000,   -0.217500],$
[   -0.0165000,   -0.217500],$
[      0.00000,   -0.217500],$
[    0.0165000,   -0.217500],$
[    0.0330000,   -0.217500],$
[   -0.0742500,  -0.0305000],$
[   -0.0577500,  -0.0305000],$
[   -0.0412500,  -0.0305000],$
[   -0.0247500,  -0.0305000],$
[  -0.00825000,  -0.0305000],$
[   0.00825000,  -0.0305000],$
[    0.0247500,  -0.0305000],$
[    0.0412500,  -0.0305000],$
[    0.0577500,  -0.0305000],$
[    0.0742500,  -0.0305000],$
[   -0.0742500,  -0.0645000],$
[   -0.0577500,  -0.0645000],$
[   -0.0412500,  -0.0645000],$
[   -0.0247500,  -0.0645000],$
[  -0.00825000,  -0.0645000],$
[   0.00825000,  -0.0645000],$
[    0.0247500,  -0.0645000],$
[    0.0412500,  -0.0645000],$
[    0.0577500,  -0.0645000],$
[    0.0742500,  -0.0645000],$
[   -0.0742500,  -0.0985000],$
[   -0.0577500,  -0.0985000],$
[   -0.0412500,  -0.0985000],$
[   -0.0247500,  -0.0985000],$
[  -0.00825000,  -0.0985000],$
[   0.00825000,  -0.0985000],$
[    0.0247500,  -0.0985000],$
[    0.0412500,  -0.0985000],$
[    0.0577500,  -0.0985000],$
[    0.0742500,  -0.0985000],$
[   -0.0742500,   -0.132500],$
[   -0.0577500,   -0.132500],$
[   -0.0412500,   -0.132500],$
[   -0.0247500,   -0.132500],$
[  -0.00825000,   -0.132500],$
[   0.00825000,   -0.132500],$
[    0.0247500,   -0.132500],$
[    0.0412500,   -0.132500],$
[    0.0577500,   -0.132500],$
[    0.0742500,   -0.132500],$
[   -0.0742500,   -0.166500],$
[   -0.0577500,   -0.166500],$
[   -0.0412500,   -0.166500],$
[   -0.0247500,   -0.166500],$
[  -0.00825000,   -0.166500],$
[   0.00825000,   -0.166500],$
[    0.0247500,   -0.166500],$
[    0.0412500,   -0.166500],$
[    0.0577500,   -0.166500],$
[    0.0742500,   -0.166500],$
[   -0.0742500,   -0.200500],$
[   -0.0577500,   -0.200500],$
[   -0.0412500,   -0.200500],$
[   -0.0247500,   -0.200500],$
[  -0.00825000,   -0.200500],$
[   0.00825000,   -0.200500],$
[    0.0247500,   -0.200500],$
[    0.0412500,   -0.200500],$
[    0.0577500,   -0.200500],$
[    0.0742500,   -0.200500]]) ; this is the coordinates of the beamlet source with respect to the beam coordinate system (z coordinate is implicitly zero)


holp(*,0)*=-0.12994/holp(0,0)
holp(*,1)*= 0.01955/holp(0,1)

; cutdown
;holp=holp(indgen(n_elements(holp(*,0))/10)*10,*)
default,cutdown,0
if cutdown eq 1 then begin
    xrr=minmax(holp(*,0))
    yrr=minmax(holp(*,1))
    sep=0.05
    nnx=round( (xrr(1)-xrr(0))/sep)
    nny=round( (yrr(1)-yrr(0))/sep)
    
    xr1=linspace(xrr(0),xrr(1),nnx)
    yr1=linspace(yrr(0),yrr(1),nny)
    print,'number of new grids=',nnx*nny,'instead of 262'
    xr2=xr1 # replicate(1,nny)
    yr2=replicate(1,nnx) # yr1
    holp=[[reform(xr2,nnx*nny)],[reform(yr2,nnx*nny)]]
endif

;stop

;


common cb, nh, ductp, srcp, zhat,xhat,yhat,xhat1a,yhat1a,zhat1a,src1a,div
nh=n_elements(holp(*,0)) ; number of holes
ductp=[3445,-1378,0.]/1000.
ducta= -178.186*!dtor






zhat = [cos(ducta),sin(ducta),0] ; direction vector along beam
yhat=[0,0,1.] ; perp to
xhat=crossp(zhat,yhat) ; perp to

distduct=10.0;5.17 ; distance that source is behind duct
hfoc=10.0 ; focal length horiz
vfoc=10.0;5.17;6.0;5.17 ; and vert
div=0.9*!dtor  ;* 0.1

; 0.35*sqrt(2)*sqrt(2)*!dtor ; divergence angle ;;!!!new clive corrected
;div=div/10.; hack
srcp=ductp - zhat * distduct ; calc source position

xhat1a=fltarr(nh,3) ; init storage of direction vectors for main axis ofeach beamlet
yhat1a=fltarr(nh,3)
zhat1a=fltarr(nh,3)
src1a=fltarr(nh,3) ; the source position in machine coordinates

for i=0,nh-1 do begin
    src1=srcp + xhat * holp(i,0) + yhat * holp(i,1) ; this defines the origin of each beamlet in cartesian coords
    zhat1 = zhat - xhat * holp(i,0) / hfoc - yhat * holp(i,1) / vfoc ; defines the main axis of each beamlet according to the focal lengths
    xhat1 = crossp(zhat1,[0,0,1.]) ; and x and y directions
    yhat1 = crossp(xhat1,zhat1)

    zhat1a(i,*)=zhat1/norm(zhat1)
    yhat1a(i,*)=yhat1/norm(yhat1)
    xhat1a(i,*)=xhat1/norm(xhat1) ; normalize vectors and store in array 
    src1a(i,*)=src1 ; and store source location
end

end


pro beam,pos,s,dir,i ;  gets beam intensity s and direction dir for a position pos.   THIS VERSION calculates for only one beamlet, index i
common cb, nh, ductp, srcp, zhat,xhat,yhat,xhat1a,yhat1a,zhat1a,src1a,div

vec1 = pos - src1a(i,*) ; the vector between position and the source for tat beamlet
dir = vec1/norm(vec1) ; dir is normalized

zc=total(vec1*zhat1a(i,*))
xc=total(vec1*xhat1a(i,*))
yc=total(vec1*yhat1a(i,*)) ; the components along the coordinate system defined for each beamlet
rad = div * zc
s = exp(-(xc^2 + yc^2) / rad^2 )/zc^2 ; now we calculate intensity by simple gaussian

end

pro beama,pos,s,dir ;  gets beam intensity s and direction dir for a position pos.  The output s and dir are arrays corresponding to every beamlet
common cb, nh, ductp, srcp, zhat,xhat,yhat,xhat1a,yhat1a,zhat1a,src1a,div

; same as above routine just loop

s=fltarr(nh)
dir=fltarr(nh,3)

for i=0,nh-1 do begin
    vec1 = pos - src1a(i,*)
    dir(i,*) = vec1/norm(vec1)

    zc=total(vec1*zhat1a(i,*))
    xc=total(vec1*xhat1a(i,*))
    yc=total(vec1*yhat1a(i,*))
    rad = div * zc
    s(i) = exp(-(xc^2 + yc^2) / rad^2 )/zc^2

endfor


end



pro tst ; this routine simply plots tests the beam velocity distribution function f(x,v) as documented. NOT NEEDED

initbeam
common cb, nh, ductp, srcp, zhat,xhat,yhat,xhat1a,yhat1a,zhat1a,src1a
pos=srcp+zhat*7 + xhat * 0. + yhat * 0. ; assume a particular location 7 m from source of beam and along beam axis

beama,pos,s,dir ;  get intensity s and direction vectors dir for that position


dirx=total( (replicate(1,nh)#xhat) * dir,2) ; take components of direction vector along xaxis of neutral beam

diry=total( (replicate(1,nh)#yhat) * dir,2) ; sam along y axis
contour,s,dirx,diry,/irr,/iso,/fill,nl=10 ;  plot
end


pro dum
initbeam
pos=[1.,0.,0.]

beama,pos,s,dir ; calculate intenstity of beamlet and direction for bealet index i0


end
